---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { slugifyTitle } from "../../../lib/slugifyTitle";
import { getCollection } from "astro:content";

const realizacje = await getCollection("realizacje");
const toDate = (value) => (value ? new Date(value) : null);
const ensureArray = (value) => (Array.isArray(value) ? value : value ? [value] : []);

const allItems = realizacje.map((item) => ({
  slug: item.slug,
  ...item.data,
  _date: toDate(item.data?.date),
}));

const groups = new Map();
allItems.forEach((item) => {
  ensureArray(item.category).forEach((cat) => {
    if (!cat || typeof cat !== "string") return;
    const trimmed = cat.trim();
    if (!trimmed) return;
    const key = trimmed.toLowerCase();
    const group = groups.get(key);
    if (group) {
      group.items.push(item);
    } else {
      groups.set(key, { name: trimmed, items: [item] });
    }
  });
});

const categories = Array.from(groups.values()).map((group) => ({
  name: group.name,
  slug: slugifyTitle(group.name),
  items: [...group.items].sort((a, b) => (b._date?.getTime() ?? 0) - (a._date?.getTime() ?? 0)),
}));

const sortedCategories = [...categories].sort((a, b) => a.name.localeCompare(b.name, "pl-PL"));

const formatDate = (value) =>
  value
    ? value.toLocaleDateString("pl-PL", {
        day: "numeric",
        month: "long",
        year: "numeric",
      })
    : "";

const pluralize = (value) => (value === 1 ? "realizacja" : value >= 2 && value <= 4 ? "realizacje" : "realizacji");

export const prerender = true;
---

<BaseLayout
  title="Archiwa realizacji"
  description="Przegląd rodzajów realizacji i projektów według kategorii."
>
  <section class="flex max-w-9xl flex-col gap-10 py-18">
    {sortedCategories.length ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {sortedCategories.map((category) => (
          <article class="group relative rounded-3xl border border-[var(--border)] bg-white/70 p-6 shadow-sm transition hover:-translate-y-1 hover:border-[var(--accent)] hover:shadow-lg">
            <div>
              <span class="rounded-full border px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.4em] text-[var(--accent)]">
                {category.items.length} {pluralize(category.items.length)}
              </span>
              <h2 class="mt-2 text-2xl font-semibold text-[var(--text)]">{category.name}</h2>
            </div>
            <p class="mt-4 text-xs text-[var(--muted)] uppercase tracking-[0.1em]">
              Ostatnia realizacja: {formatDate(category.items[0]?._date)}
            </p>
            <div class="mt-6 h-[120px] rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)]/40"></div>
            <a href={`/realizacje/rodzaj/${category.slug}/`} class="absolute inset-0" aria-label={`Zobacz archiwum: ${category.name}`}></a>
          </article>
        ))}
      </div>
    ) : (
      <div class="rounded-2xl border border-dashed border-[var(--border)] bg-white/70 p-6 text-center text-sm text-[var(--muted)]">
        Brak kategorii w realizacjach.
      </div>
    )}
  </section>
</BaseLayout>
