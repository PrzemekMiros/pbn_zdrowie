---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { resolveContentImage } from '../../utils/resolveContentImage';

export const prerender = true;

export async function getStaticPaths() {
  const entries = await getCollection('realizacje');
  const items = entries.sort((a, b) => b.data.order - a.data.order);

  const paths = await Promise.all(items.map(async (entry, index) => {
    const prevItem = index > 0 ? items[index - 1] : null;
    const nextItem = index < items.length - 1 ? items[index + 1] : null;
    const { Content } = await entry.render();

    return {
      params: { slug: entry.slug },
      props: {
        realizacja: { slug: entry.slug, ...entry.data },
        Content,
        prevRealizacja: prevItem ? { slug: prevItem.slug, title: prevItem.data.title } : null,
        nextRealizacja: nextItem ? { slug: nextItem.slug, title: nextItem.data.title } : null,
      },
    };
  }));

  return paths;
}

const { realizacja, Content, prevRealizacja, nextRealizacja } = Astro.props;
const headerImage = resolveContentImage(realizacja?.imageMain ?? realizacja?.thumbnail ?? realizacja?.tileImage);
const date = realizacja?.date ? new Date(realizacja.date) : null;
const year = date && !Number.isNaN(date.getTime()) ? date.getFullYear() : null;

if (!realizacja) {
  return Astro.redirect('/realizacje');
}
---

<BaseLayout
  title={realizacja.title ?? realizacja.slug}
  description={realizacja.description}
  showHero={false}
  robots={"realizacja.robots"}
>

<section class="pb-16 pt-26 md:pb-20 md:pt-38">
  <div class="grid gap-8 md:gap-12 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)] items-start">
  {/* Lewa kolumna: Obrazek z Twoim charakterystycznym obramowaniem i lekkim desaturatem */}
  <div class="relative group">
    {headerImage ? (
      <div class="overflow-hidden rounded-2xl border border-white/10">
        <Image
          class="aspect-square w-full object-cover opacity-90 transition-all duration-700 group-hover:opacity-100 group-hover:scale-[1.02]"
          src={headerImage}
          alt={realizacja.title ?? realizacja.slug}
          widths={[320, 480, 768, 960, 1100, 1400]}
          sizes="(max-width: 1024px) 100vw, 800px"
          loading="lazy"
          placeholder="blur"
        />
      </div>
    ) : (
      <div class="grid aspect-square place-items-center rounded-2xl border border-dashed border-white/10 bg-neutral-100 text-[10px] uppercase tracking-widest text-neutral-500">
        Brak wizualizacji projektu
      </div>
    )}
    {/* Dekoracyjny element - pomarańczowy akcent w rogu obrazka, nawiązujący do Twojego Hero */}
    <div class="absolute -bottom-2 -left-2 h-12 w-12 bg-orange-600/20 blur-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
  </div>

  {/* Prawa kolumna: Detale projektu */}
  <div class="sticky top-34 space-y-10">

      <div class="col-span-2 pt-4">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-semibold tracking-tight text-black mb-8">
          {realizacja.title}
        </h1>
        {realizacja.link && (
          <a 
            href={realizacja.link} 
            rel="noopener" 
            target="_blank" 
            class="group inline-flex items-center gap-3 text-xs uppercase tracking-[0.1em] font-semibold hover:text-[var(--accent)] transition-colors"
          >
            <span>Zobacz online</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        )}
      </div>

    {/* Dynamiczna treść MDX/Content */}
    {Content ? (
      <div class="prose prose-invert prose-sm max-w-none text-neutral-500 
        [&>p]:leading-relaxed [&>p]:mb-4
        [&>h2]:text-white [&>h2]:text-xl [&>h2]:font-bold [&>h2]:mt-8 [&>h2]:mb-4
        [&>ul]:list-disc [&>ul]:pl-5 [&>ul]:space-y-2
        [&>a]:text-orange-500 [&>a]:no-underline hover:[&>a]:underline">
        <Content />
      </div>
    ) : null}

      <div class="grid gap-12 md:grid-cols-[minmax(0,2fr)_minmax(0,4fr)] pt-10 border-t border-black/20">

      {realizacja.category?.length && (
        <div class="">
          <p class="text-[10px] uppercase tracking-[0.2em] text-neutral-500 font-bold mb-3">Zakres prac</p>
          <div class="flex flex-wrap gap-2">
            {realizacja.category.map((cat) => (
              <span class="text-sm text-neutral-00 font-medium">
                {cat}
              </span>
            ))}
          </div>
        </div>
      )}

      {year && (
        <div>
          <p class="text-[10px] uppercase tracking-[0.2em] text-neutral-500 font-bold mb-3">Rok</p>
          <p class="text-sm text-neutral-00 font-medium">{year}</p>
        </div>
      )}

      </div>

    </div>

  </div>

  <div class="mt-10 border-t border-black/5 pt-6">
    <div class="flex flex-col gap-6">
      {(prevRealizacja || nextRealizacja) && (
        <div class="grid gap-4 sm:grid-cols-2">
          {prevRealizacja ? (
            <a
              class="group rounded-xl border border-black/10 px-5 py-4 transition-all duration-300 hover:border-orange-600/40 hover:bg-orange-50/60"
              href={`/realizacje/${prevRealizacja.slug}/`}
              aria-label={`Poprzednia realizacja: ${prevRealizacja.title ?? prevRealizacja.slug}`}
            >
              <span class="block text-[10px] uppercase tracking-[0.2em] text-neutral-500 font-semibold mb-2">
                Poprzednia realizacja
              </span>
              <span class="text-sm font-medium text-neutral-800 group-hover:text-orange-700">
                {prevRealizacja.title ?? prevRealizacja.slug}
              </span>
            </a>
          ) : null}
          {nextRealizacja ? (
            <a
              class="group rounded-xl border border-black/10 px-5 py-4 transition-all duration-300 hover:border-orange-600/40 hover:bg-orange-50/60 sm:text-right"
              href={`/realizacje/${nextRealizacja.slug}/`}
              aria-label={`Kolejna realizacja: ${nextRealizacja.title ?? nextRealizacja.slug}`}
            >
              <span class="block text-[10px] uppercase tracking-[0.2em] text-neutral-500 font-semibold mb-2">
                Kolejna realizacja
              </span>
              <span class="text-sm font-medium text-neutral-800 group-hover:text-orange-700">
                {nextRealizacja.title ?? nextRealizacja.slug}
              </span>
            </a>
          ) : null}
        </div>
      )}
    </div>
  </div>
</section>

</BaseLayout>
