---
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import RealizacjeHero from "../../layouts/heroes/RealizacjeHero.astro";

export const prerender = true;

const imageEntries = import.meta.glob("/src/content/realizacje/img/**/*", { eager: true });
const resolveContentImage = (path) => {
  if (!path) return null;
  const normalized = path.startsWith("/src/") ? path : `/src${path}`;
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

export function getStaticPaths() {
  const entries = import.meta.glob('../../content/realizacje/*.md', { eager: true });
  return Object.entries(entries).map(([file, entry]) => {
    const slug = file.split('/').pop().replace('.md', '');
    return {
      params: { slug },
      props: { realizacja: { slug, ...entry.frontmatter }, Content: entry.Content },
    };
  });
}

const { realizacja, Content } = Astro.props;
const headerImage = resolveContentImage(realizacja?.imageMain ?? realizacja?.thumbnail ?? realizacja?.tileImage);
const date = realizacja?.date ? new Date(realizacja.date) : null;
const year = date && !Number.isNaN(date.getTime()) ? date.getFullYear() : null;

if (!realizacja) {
  return Astro.redirect('/realizacje');
}
---

<BaseLayout
  title={realizacja.title ?? realizacja.slug}
  description={realizacja.description}
  showHero={false}
>
  <RealizacjeHero title={realizacja.title ?? realizacja.slug} lead={realizacja.description} />
  <a class="mt-6 inline-flex items-center gap-2 text-sm font-semibold text-[var(--muted)] hover:text-[var(--text)]" href="/realizacje/" title="Wroc do listy realizacji">&larr; Wroc do listy</a>
  <section class="mt-10 grid gap-8 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
    {headerImage ? (
      <Image
        class="aspect-[4/4] w-full rounded-2xl border border-[var(--border)] object-cover"
        src={headerImage}
        alt={realizacja.title ?? realizacja.slug}
        widths={[320, 480, 768, 960, 1100, 1400]}
        sizes="(max-width: 768px) 100vw, 1100px"
        loading="lazy"
        placeholder="blur"
      />
    ) : (
      <div class="grid aspect-[4/4] place-items-center rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)] text-xs uppercase tracking-widest text-[var(--muted)]">Brak zdjecia</div>
    )}
    <div class="space-y-4">
      {realizacja.description ? <p class="text-[var(--muted)]">{realizacja.description}</p> : null}
      {realizacja.client ? <p class="text-[var(--muted)]">{realizacja.client}</p> : null}
      {year ? <p class="text-[var(--muted)]">{year}</p> : null}
      {realizacja.link ? (
        <p class="text-[var(--muted)]">
          <a class="underline decoration-[var(--accent)] underline-offset-4 hover:text-[var(--text)]" href={realizacja.link} rel="noopener" target="_blank" title={`Otworz strone: ${realizacja.link}`}>
            {realizacja.link}
          </a>
        </p>
      ) : null}
    </div>
  </section>

  {realizacja.category?.length ? (
    <section class="mt-12 space-y-2">
      <h2 class="text-xl font-semibold">Zakres</h2>
      <p class="text-sm text-[var(--muted)]">{realizacja.category.join(", ")}</p>
    </section>
  ) : null}
  {Content ? (
    <section class="mt-10 space-y-4 text-[17px] leading-7 text-[var(--text)] [&>a]:underline [&>a]:decoration-[var(--accent)] [&>a]:underline-offset-4 [&>blockquote]:border-l-4 [&>blockquote]:border-[var(--border)] [&>blockquote]:pl-4 [&>blockquote]:text-[var(--muted)] [&>h2]:mt-8 [&>h2]:text-2xl [&>h2]:font-semibold [&>h3]:mt-6 [&>h3]:text-xl [&>h3]:font-semibold [&>hr]:border-[var(--border)] [&>li]:mt-2 [&>ol]:list-decimal [&>ol]:pl-6 [&>p]:leading-7 [&>ul]:list-disc [&>ul]:pl-6">
      <Content />
    </section>
  ) : null}
</BaseLayout>
