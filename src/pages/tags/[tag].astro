---
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { slugifyTitle } from "../../lib/slugifyTitle";

const entries = import.meta.glob("../../content/artykuly/*.md", { eager: true });
const articles = Object.entries(entries)
  .map(([file, entry]) => {
    const slug = file.split("/").pop().replace(".md", "");
    return { slug, ...entry.frontmatter };
  })
  .map((art) => ({
    ...art,
    date: art.date ? new Date(art.date) : null,
  }))
  .sort((a, b) => {
    const dateA = a.date ? a.date.getTime() : 0;
    const dateB = b.date ? b.date.getTime() : 0;
    return dateB - dateA;
  });

function collectTags() {
  const map = new Map<string, string>();
  articles.forEach((article) => {
    const tags = Array.isArray(article.tags) ? article.tags : article.tags ? [article.tags] : [];
    tags.forEach((tag) => {
      if (!tag?.trim()) return;
      const slug = slugifyTitle(tag);
      map.set(slug, tag.trim());
    });
  });
  return map;
}

export function getStaticPaths() {
  const entries = import.meta.glob("../../content/artykuly/*.md", { eager: true });
  const pathsTagMap = new Map<string, string>();
  Object.values(entries).forEach((entry) => {
    const tags = Array.isArray(entry.frontmatter?.tags)
      ? entry.frontmatter.tags
      : entry.frontmatter?.tags
      ? [entry.frontmatter.tags]
      : [];
    tags.forEach((tag) => {
      if (!tag?.trim()) return;
      const slug = slugifyTitle(tag);
      pathsTagMap.set(slug, tag.trim());
    });
  });
  return Array.from(pathsTagMap.keys()).map((slug) => ({
    params: { tag: slug },
  }));
}

const tagMap = collectTags();
const sortedCategories = Array.from(tagMap.entries()).sort((a, b) => a[1].localeCompare(b[1], "pl-PL"));

const currentSlug = Astro.params.tag;
const currentTag = tagMap.get(currentSlug) ?? currentSlug;

const filteredArticles = articles.filter((article) => {
  const tags = Array.isArray(article.tags) ? article.tags : article.tags ? [article.tags] : [];
  return tags.some((tag) => slugifyTitle(tag) === currentSlug);
});

const filteredCount = filteredArticles.length;
const filteredLabel = filteredCount === 1 ? "artykuł" : filteredCount >= 2 && filteredCount <= 4 ? "artykuły" : "artykułów";
const heroMeta = `${filteredCount} ${filteredLabel}`;

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const filename = normalized.split("/").pop();
    normalized = `/src/content/artykuly/img/${filename}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const formatDate = (value) =>
  value
    ? value.toLocaleDateString("pl-PL", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      })
    : null;

export const prerender = true;
---

<BaseLayout
  title={`${currentTag}`}
  description={`Lista wszystkich artykułów oznaczonych tagiem ${currentTag}.`}
  heroMeta={heroMeta}
>
  <section class="mb-16 mt-12 md:mb-24 md:mt-16">
    <div class="grid gap-16 lg:grid-cols-[minmax(0,1fr)_300px]">
      <div class="space-y-16">
        <!-- 
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[var(--accent)]">
            {filteredArticles.length} {filteredArticles.length === 1 ? "artykuł" : "artykułów"}
          </p>
        </div>
        -->

        {filteredArticles.length ? (
          filteredArticles.map((artykul) => {
            const image = resolveArticleImage(artykul.tileImage ?? artykul.thumbnail);
            const displayDate = artykul.date ? formatDate(artykul.date) : null;
            const tag = Array.isArray(artykul.tags) ? artykul.tags[0] : artykul.tags;
            const author = artykul.author ?? "Redakcja";
            const initials = author
              .split(" ")
              .filter(Boolean)
              .slice(0, 2)
              .map((part) => part[0])
              .join("")
              .toUpperCase();

            return (
              <article class="relative isolate flex flex-col gap-8 md:flex-row group">
                <div class="relative aspect-[16/9] sm:aspect-[2/1] md:w-80 md:shrink-0 overflow-hidden rounded-xl">
                  {image ? (
                    <Image
                      class="absolute inset-0 h-full w-full object-cover transition-all duration-700 ease-in-out group-hover:scale-105 group-hover:opacity-100"
                      src={image}
                      alt={artykul.title ?? artykul.slug}
                      widths={[320, 480]}
                      sizes="320px"
                      loading="lazy"
                    />
                  ) : (
                    <div class="absolute inset-0 grid place-items-center text-[10px] uppercase tracking-widest text-neutral-500">
                      Brak zdjęcia
                    </div>
                  )}
                  <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-white/10"></div>
                </div>

                <div class="flex flex-col justify-center">
                  <div class="flex items-center gap-x-4 text-[11px] uppercase tracking-wider">
                    {tag ? (
                      <span class="font-bold text-orange-600">{tag}</span>
                    ) : null}
                    {displayDate ? (
                      <time datetime={artykul.date?.toISOString()} class="text-neutral-500">
                        {displayDate}
                      </time>
                    ) : null}
                  </div>

                  <div class="relative max-w-xl">
                    <h2 class="mt-3 text-xl md:text-2xl font-semibold leading-tight">
                      <a href={`/artykuly/${artykul.slug}/`}>
                        <span class="absolute inset-0"></span>
                        {artykul.title ?? artykul.slug}
                      </a>
                    </h2>
                    {artykul.description ? (
                      <p class="mt-4 text-sm leading-relaxed text-neutral-500 line-clamp-2">{artykul.description}</p>
                    ) : null}
                  </div>

                  <div class="mt-6 flex items-center gap-x-3 text-xs">
                    <div class="flex h-8 w-8 items-center justify-center rounded-full bg-neutral-800 border border-white/10 text-[10px] font-bold text-white">
                      {initials}
                    </div>
                    <span class="text-neutral-500">{author}</span>
                  </div>
                </div>
              </article>
            );
          })
        ) : (
          <div class="rounded-2xl border border-dashed border-[var(--border)] bg-white/70 p-6 text-center text-sm text-[var(--muted)]">
            Nie znaleziono artykułów z tym tagiem. Wróć do pełnej listy{" "}
            <a href="/artykuly/" class="font-semibold text-[var(--accent)] underline">
              artykułów
            </a>
            .
          </div>
        )}
      </div>

      <aside class="sticky top-34 self-start space-y-8">
        <div>
          <h3 class="text-xs font-bold uppercase tracking-[0.2em] mb-6 border-l-2 border-orange-600 pl-4">Kategorie</h3>
          {sortedCategories.length ? (
            <ul class="space-y-2">
              {sortedCategories.map(([slug, label]) => {
                const isActive = slug === currentSlug;
                const linkClass = [
                  "block rounded-xl border px-4 py-3 text-sm transition-all",
                  isActive
                    ? "bg-orange-50 border-orange-500/40 text-orange-700"
                    : "bg-gray-100 border-white/5 text-neutral-600 hover:border-orange-600/50 hover:text-orange-700",
                ].join(" ");
                return (
                  <li key={slug}>
                    <a href={`/tags/${slug}/`} class={linkClass} aria-current={isActive ? "page" : undefined}>
                      {label}
                    </a>
                  </li>
                );
              })}
            </ul>
          ) : (
            <p class="text-sm text-neutral-500">Brak kategorii</p>
          )}
        </div>
      </aside>
    </div>
  </section>
</BaseLayout>
