---
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticlesHero from "../../layouts/heroes/ArticlesHero.astro";

export const prerender = true;

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const filename = normalized.split("/").pop();
    normalized = `/src/content/artykuly/img/${filename}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

export function getStaticPaths() {
  const entries = import.meta.glob('../../content/artykuly/*.md', { eager: true });
  return Object.entries(entries).map(([file, entry]) => {
    const slug = file.split('/').pop().replace('.md', '');
    return {
      params: { slug },
      props: { artykul: { slug, ...entry.frontmatter }, Content: entry.Content },
    };
  });
}

const { artykul, Content } = Astro.props;
const headerImage = resolveArticleImage(artykul?.tileImage ?? artykul?.thumbnail);

if (!artykul) {
  return Astro.redirect('/artykuly');
}
---

<BaseLayout
  title={artykul.title ?? artykul.slug}
  description={artykul.description}
  showHero={false}
>
  <ArticlesHero title={artykul.title ?? artykul.slug} lead={artykul.description} />
  <article class="-mt-60 mb-18 space-y-12 z-50">
    <header class="mb-16">
      <div class="mx-auto max-w-3xl space-y-12">
        <div class="space-y-4 text-sm text-[var(--muted)]">
          {artykul.role ? <p>{artykul.role}</p> : null}
          {artykul.year ? <p>{artykul.year}</p> : null}
          {artykul.href ? (
            <p>
              <a class="underline decoration-[var(--accent)] underline-offset-4 hover:text-[var(--text)]" href={artykul.href} rel="noopener" target="_blank" title={`Otworz strone: ${artykul.href}`}>
                {artykul.href}
              </a>
            </p>
          ) : null}
        </div>
      </div>
      {headerImage ? (
        <Image
          class="aspect-[16/9] rounded-2xl border border-[var(--border)] object-cover"
          src={headerImage}
          alt={artykul.title ?? artykul.slug}
          widths={[480, 768, 960, 1100, 1400, 1680]}
          sizes="(max-width: 1320px) 100vw, 1320px"
          loading="lazy"
          placeholder="blur"
        />
      ) : (
        <div class="grid aspect-[16/9] w-5xl place-items-center rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)] text-xs uppercase tracking-widest text-[var(--muted)]">Brak zdjecia</div>
      )}
    </header>

    {artykul.classes?.length ? (
      <section class="mx-auto max-w-3xl space-y-2">
        <h2 class="text-lg font-semibold text-[var(--text)]">Zakres</h2>
        <p class="text-sm leading-6 text-[var(--muted)]">{artykul.classes.join(", ")}</p>
      </section>
    ) : null}
    {Content ? (
      <section class="mx-auto max-w-3xl space-y-6 text-[17px] leading-8 text-[var(--text)] sm:text-lg sm:leading-8 [&>a]:underline [&>a]:decoration-[var(--accent)] [&>a]:underline-offset-4 [&>blockquote]:border-l-4 [&>blockquote]:border-[var(--border)] [&>blockquote]:pl-6 [&>blockquote]:text-[var(--muted)] [&>h2]:mt-10 [&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:text-[var(--text)] [&>h3]:mt-8 [&>h3]:text-xl [&>h3]:font-semibold [&>h3]:text-[var(--text)] [&>hr]:border-[var(--border)] [&>li]:mt-2 [&>ol]:list-decimal [&>ol]:pl-6 [&>p]:leading-8 [&>ul]:list-disc [&>ul]:pl-6">
        <Content />
      </section>
    ) : null}
  </article>
</BaseLayout>
