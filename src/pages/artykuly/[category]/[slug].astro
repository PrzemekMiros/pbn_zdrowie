---
import { Image } from "astro:assets";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ArticlesHero from "../../../layouts/heroes/ArticlesHero.astro";
import settings from "../../../content/ustawienia.json";
import { slugifyTitle } from "../../../lib/slugifyTitle";

export const prerender = true;

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const relativePath = normalized.slice("/content/posts/img/".length);
    normalized = `/src/content/artykuly/img/${relativePath}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

function getSlugPathFromFile(file) {
  return file.replace(/^.*content\/artykuly\//, "").replace(/\.md$/, "");
}
function getCategorySlug(frontmatter, slugPath) {
  const parts = slugPath.split("/");
  if (parts.length > 1) return parts[0];
  const categoryValue = Array.isArray(frontmatter?.category)
    ? frontmatter.category[0]
    : frontmatter?.category;
  return categoryValue ? slugifyTitle(categoryValue) : "artykuly";
}
function getArticleSlug(slugPath) {
  const parts = slugPath.split("/");
  return parts.length > 1 ? parts.slice(1).join("/") : slugPath;
}

export function getStaticPaths() {
  const getSlugPathFromFileLocal = (file) =>
    file.replace(/^.*content\/artykuly\//, "").replace(/\.md$/, "");
  const getCategorySlugLocal = (frontmatter, slugPath) => {
    const parts = slugPath.split("/");
    if (parts.length > 1) return parts[0];
    const categoryValue = Array.isArray(frontmatter?.category)
      ? frontmatter.category[0]
      : frontmatter?.category;
    return categoryValue ? slugifyTitle(categoryValue) : "artykuly";
  };
  const getArticleSlugLocal = (slugPath) => {
    const parts = slugPath.split("/");
    return parts.length > 1 ? parts.slice(1).join("/") : slugPath;
  };
  const entries = import.meta.glob("../../../content/artykuly/**/*.md", { eager: true });
  return Object.entries(entries).map(([file, entry]) => {
    const slugPath = getSlugPathFromFileLocal(file);
    const categorySlug = getCategorySlugLocal(entry.frontmatter ?? {}, slugPath);
    const slug = getArticleSlugLocal(slugPath);
    return {
      params: { category: categorySlug, slug },
      props: {
        artykul: { slug, categorySlug, ...entry.frontmatter },
        Content: entry.Content,
      },
    };
  });
}

const { artykul, Content } = Astro.props;
const allArticleEntries = import.meta.glob("../../../content/artykuly/**/*.md", { eager: true });
const allArticles = Object.entries(allArticleEntries).map(([file, entry]) => {
  const slugPath = getSlugPathFromFile(file);
  const categorySlug = getCategorySlug(entry.frontmatter ?? {}, slugPath);
  const slug = getArticleSlug(slugPath);
  return {
    slug,
    categorySlug,
    ...entry.frontmatter,
  };
});
const getTag = (article) => {
  const tag = Array.isArray(article?.tags) ? article.tags[0] : article?.tags;
  return tag ?? "Artykul";
};
allArticles.sort((a, b) => {
  const aDate = a?.date ? new Date(a.date).getTime() : 0;
  const bDate = b?.date ? new Date(b.date).getTime() : 0;
  return bDate - aDate;
});
const currentIndex = allArticles.findIndex((item) => item.slug === artykul?.slug);
const relatedArticles = [];
if (allArticles.length > 1) {
  const startIndex = currentIndex >= 0 ? currentIndex : 0;
  for (let offset = 1; offset <= allArticles.length && relatedArticles.length < 3; offset += 1) {
    const candidate = allArticles[(startIndex + offset) % allArticles.length];
    if (candidate?.slug && candidate.slug !== artykul?.slug) {
      relatedArticles.push(candidate);
    }
  }
}
const headerImage = resolveArticleImage(artykul?.tileImage ?? artykul?.thumbnail);
const { site } = Astro;
const baseUrl = site ? site.toString().replace(/\/$/, "") : "";
const articleUrl = baseUrl
  ? `${baseUrl}/artykuly/${artykul?.categorySlug ?? ""}/${artykul?.slug ?? ""}/`
  : `/artykuly/${artykul?.categorySlug ?? ""}/${artykul?.slug ?? ""}/`;
const siteName = settings.siteTitle ?? "Strona";
const siteLogo = settings.logo ? (baseUrl ? `${baseUrl}${settings.logo}` : settings.logo) : "";
const authorName = artykul?.author ?? "Redakcja";
const datePublished = artykul?.date ? new Date(artykul.date) : null;
const dateModified = artykul?.updated ? new Date(artykul.updated) : datePublished;

if (!artykul) {
  return Astro.redirect('/artykuly');
}
---

<BaseLayout
  title={artykul.title ?? artykul.slug} 
  description={artykul.description}
  showHero={false}
  robots={artykul.robots}
>
  <ArticlesHero 
    title={artykul.title ?? artykul.slug} 
    lead={artykul.description}
    tags={artykul.tags}
    date={artykul.date}
  />
  <article
    class="-mt-30 md:-mt-85 mb-18 space-y-12 z-50"
    itemscope
    itemtype="https://schema.org/BlogPosting"
  >
    <meta itemprop="mainEntityOfPage" content={articleUrl} />
    <meta itemprop="url" content={articleUrl} />
    <meta itemprop="headline" content={artykul.title ?? artykul.slug} />
    {artykul.description ? <meta itemprop="description" content={artykul.description} /> : null}
    {datePublished ? <meta itemprop="datePublished" content={datePublished.toISOString()} /> : null}
    {dateModified ? <meta itemprop="dateModified" content={dateModified.toISOString()} /> : null}
    <div itemprop="author" itemscope itemtype="https://schema.org/Person">
      <meta itemprop="name" content={authorName} />
    </div>
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
      <meta itemprop="name" content={siteName} />
      {siteLogo ? <meta itemprop="logo" content={siteLogo} /> : null}
    </div>
    <header class="mb-8 md:mb-16">
      <div class="mx-auto max-w-3xl space-y-12">
        <div class="space-y-4 text-sm text-[var(--muted)]">
          {artykul.role ? <p>{artykul.role}</p> : null}
          {artykul.year ? <p>{artykul.year}</p> : null}
          {artykul.href ? (
            <p>
              <a class="underline decoration-[var(--accent)] underline-offset-4 hover:text-[var(--text)]" href={artykul.href} rel="noopener" target="_blank" title={`Otworz strone: ${artykul.href}`}>
                {artykul.href}
              </a>
            </p>
          ) : null}
        </div>
      </div>
      {headerImage ? (
        <Image
          class="aspect-[16/9] rounded-xl border border-[var(--border)] object-cover"
          src={headerImage}
          alt={artykul.title ?? artykul.slug}
          widths={[480, 768, 960, 1100, 1400, 1680]}
          sizes="(max-width: 1320px) 100vw, 1320px"
          loading="lazy"
          placeholder="blur"
          itemprop="image"
        />
      ) : (
        <div class="grid aspect-[16/9] w-5xl place-items-center rounded-xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)] text-xs uppercase tracking-widest text-[var(--muted)]">Brak zdjecia</div>
      )}
    </header>

    {artykul.classes?.length ? (
      <section class="mx-auto max-w-3xl space-y-2">
        <h2 class="text-lg font-semibold text-[var(--text)]">Zakres</h2>
        <p class="text-sm leading-6 text-[var(--muted)]">{artykul.classes.join(", ")}</p>
      </section>
    ) : null}
    {Content ? (
<section class="mx-auto max-w-2xl space-y-6 text-[16px] leading-relaxed text-[var(--text)] sm:text-[17px] sm:leading-relaxed 
  [&>a]:underline [&>a]:decoration-[var(--accent)] [&>a]:underline-offset-4 [&>a]:font-medium hover:[&>a]:text-[var(--accent)]
  [&>blockquote]:border-l-4 [&>blockquote]:border-[var(--accent)] [&>blockquote]:pl-6 [&>blockquote]:italic [&>blockquote]:text-[var(--muted)] 
  [&>h2]:mt-10 [&>h2]:mb-4 [&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:tracking-tight [&>h2]:text-[var(--text)] 
  [&>h3]:mt-7 [&>h3]:mb-3 [&>h3]:text-xl [&>h3]:font-semibold [&>h3]:text-[var(--text)] 
  [&>hr]:my-8 [&>hr]:border-[var(--border)] 
  [&>li]:mt-3 [&>ol]:list-decimal [&>ol]:pl-6 [&>ul]:list-disc [&>ul]:pl-6
  [&>p]:mb-5 [&>p]:last:mb-0">
  <Content />
</section>
    ) : null}

    {relatedArticles.length ? (
      <section class="mx-auto max-w-7xl space-y-6 pt-6 mt-16 border-t border-black/10">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-[var(--text)]">Przeczytaj też</h2>
          <a href="/artykuly/" class="flex items-center gap-3 group text-black/90 font-bold text-[11px] uppercase tracking-widest hover:text-orange-600 transition-colors  hidden md:block">Wszystkie wpisy <span class="text-orange-600 text-lg -translate-y-0.5 group-hover:translate-x-1 transition-transform">»»»</span>
  </a>
        </div>
        <div class="grid gap-5 md:grid-cols-3">
          {relatedArticles.map((item) => {
            const itemImage = resolveArticleImage(item?.tileImage ?? item?.thumbnail);
            const itemUrl = baseUrl
              ? `${baseUrl}/artykuly/${item?.categorySlug ?? ""}/${item?.slug ?? ""}/`
              : `/artykuly/${item?.categorySlug ?? ""}/${item?.slug ?? ""}/`;
            return (
              <a
                class="group flex h-full w-full flex-col rounded-2xl border border-[var(--border)] bg-white px-5 pb-8 pt-6 md:px-6 transition-transform hover:scale-[1.02]"
                href={itemUrl}
              >
                <div class="mb-4 flex items-start justify-between">
                  <span class="flex items-center gap-2 rounded-full border border-black/20 px-3 py-1.5 text-[10px] font-bold uppercase text-black">
                    <span class="flex h-3 w-3 items-center justify-center rounded-sm bg-[var(--accent)] text-[8px] text-white">II</span>
                    {getTag(item)}
                  </span>
                  <div class="rounded-full border border-black/20 p-2">
                    <svg class="h-3 w-3 text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                    </svg>
                  </div>
                </div>

                <div class="mb-6">
                  {itemImage ? (
                    <Image
                      class="h-[185px] w-full rounded-xl border border-black/10 object-cover"
                      src={itemImage}
                      alt={item?.title ?? item?.slug}
                      widths={[360, 520, 720]}
                      sizes="(max-width: 900px) 100vw, 320px"
                      loading="lazy"
                      placeholder="blur"
                    />
                  ) : (
                    <div class="grid h-[185px] w-full place-items-center rounded-xl border border-black/10 bg-black/5 text-[11px] uppercase tracking-widest text-black/60">
                      Brak zdjecia
                    </div>
                  )}
                </div>

                <div class="">
                  <h3 class="mb-3 text-xl font-semibold leading-snug text-black line-clamp-2">
                    {item?.title ?? item?.slug}
                  </h3>
                  {item?.description ? (
                    <p class="text-sm leading-relaxed text-black/70 line-clamp-3">{item.description}</p>
                  ) : null}
                </div>
              </a>
            );
          })}
        </div>
      </section>
    ) : null}
  </article>
</BaseLayout>
