---
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticlesHero from "../../layouts/heroes/ArticlesHero.astro";

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const filename = normalized.split("/").pop();
    normalized = `/src/content/artykuly/img/${filename}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const entries = import.meta.glob('../../content/artykuly/*.md', { eager: true });
const items = Object.entries(entries)
  .map(([file, entry]) => {
    const slug = file.split('/').pop().replace('.md', '');
    return { slug, ...entry.frontmatter };
  })
  .sort((a, b) => {
    const dateA = a.date ? new Date(a.date).getTime() : 0;
    const dateB = b.date ? new Date(b.date).getTime() : 0;
    return dateB - dateA;
  });

const categories = Array.from(
  items.reduce((set, item) => {
    const tags = Array.isArray(item.tags) ? item.tags : item.tags ? [item.tags] : [];
    tags.forEach((tag) => set.add(tag));
    return set;
  }, new Set())
).sort((a, b) => a.localeCompare(b, "pl-PL"));
---

<BaseLayout
  title="Porady i ciekawostki"
  description="Praktyczne porady, trendy i ciekawostki o stronach, SEO i marketingu. Przegladaj najnowsze artykuly."
  showHero={false}
>
  <ArticlesHero
    title="Porady i ciekawostki"
    lead="Kompleksowo prowadzŽt od strategii, przez design, po wdro‘•enie i wsparcie. Minimalistycznie, szybko i z myślą o wynikach. "
  />
  <section class="mb-24 mt-12">
      <div class="grid gap-10 lg:grid-cols-[minmax(0,1fr)_260px]">
        <div class="mt-8 space-y-20 lg:space-y-20">
          {items.map((artykul) => {
            const image = resolveArticleImage(artykul.tileImage ?? artykul.thumbnail);
            const date = artykul.date ? new Date(artykul.date) : null;
            const formattedDate = date ? date.toLocaleDateString("pl-PL", { day: "2-digit", month: "short", year: "numeric" }) : null;
            const tag = Array.isArray(artykul.tags) ? artykul.tags[0] : artykul.tags;
            const author = artykul.author ?? "Redakcja";
            const initials = author
              .split(" ")
              .filter(Boolean)
              .slice(0, 2)
              .map((part) => part[0])
              .join("")
              .toUpperCase();
            return (
              <article class="relative isolate flex flex-col gap-8 lg:flex-row">
                <div class="relative aspect-[16/9] sm:aspect-[2/1] lg:w-96 lg:shrink-0">
                  {image ? (
                    <Image
                      class="absolute inset-0 h-full w-full rounded-2xl bg-gray-50 object-cover"
                      src={image}
                      alt={artykul.title ?? artykul.slug}
                      widths={[320, 480, 768, 960]}
                      sizes="(max-width: 1024px) 100vw, 256px"
                      loading="lazy"
                      placeholder="blur"
                    />
                  ) : (
                    <div class="absolute inset-0 grid place-items-center rounded-2xl bg-gray-800 text-xs uppercase tracking-widest text-gray-300">Brak zdjecia</div>
                  )}
                  <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-gray-900/10"></div>
                </div>
                <div>
                  <div class="flex items-center gap-x-4 text-xs">                 
                    {tag ? (
                      <span class="relative z-10 rounded-full bg-gray-800 px-3 py-1.5 font-medium text-gray-300">
                        {tag}
                      </span>
                    ) : null}
                     {date ? <time datetime={date.toISOString()} class="text-gray-400">{formattedDate}</time> : null}
                  </div>
                  <div class="group relative max-w-xl">
                    <h2 class="mt-3 text-2xl font-semibold leading-6 text-[var(--text)] group-hover:text-[var(--muted)]">
                      <a href={`/artykuly/${artykul.slug}/`} title={`Zobacz artykul: ${artykul.title ?? artykul.slug}`} aria-label={`Zobacz artykul: ${artykul.title ?? artykul.slug}`}>
                        <span class="absolute inset-0"></span>
                        {artykul.title ?? artykul.slug}
                      </a>
                    </h2>
                    {artykul.description ? (
                      <p class="mt-5 text-sm leading-6 text-gray-400">{artykul.description}</p>
                    ) : null}
                  </div>
                  <div class="mt-6 flex border-t border-white/10 pt-6">
                    <div class="relative flex items-center gap-x-4">
                      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-800 text-xs font-bold text-white">{initials}</div>
                      <div class="text-sm leading-6">
                        <p class="font-semibold text-gray-400">{author}</p>
                        {artykul.role ? <p class="text-gray-400">{artykul.role}</p> : null}
                      </div>
                    </div>
                  </div>
                </div>
              </article>
            );
          })} 
        </div>
        <aside class="sticky mt-8 top-24 self-start rounded-2xl bg-gray-100 p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold uppercase tracking-[0.2em]">Kategorie</h2>
            <span class="text-[10px] uppercase tracking-[0.3em]">Wpisy</span>
          </div>
          {categories.length ? (
            <ul class="mt-4 space-y-3 text-sm">
              {categories.map((category) => (
                <li class="rounded-full bg-white px-4 py-3 backdrop-blur-sm">{category}</li>
              ))}
            </ul>
          ) : (
            <p class="mt-4 text-sm">Brak kategorii</p>
          )}
        </aside>
      </div>
  </section>
</BaseLayout>
