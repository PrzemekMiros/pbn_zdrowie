---
import { Image } from "astro:assets";
import { slugifyTitle } from "../../lib/slugifyTitle";

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const relativePath = normalized.slice("/content/posts/img/".length);
    normalized = `/src/content/artykuly/img/${relativePath}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const entries = import.meta.glob("../../content/artykuly/**/*.md", { eager: true });
const getSlugPathFromFile = (file) =>
  file.replace(/^.*content\/artykuly\//, "").replace(/\.md$/, "");
const getCategorySlug = (frontmatter, slugPath) => {
  const parts = slugPath.split("/");
  if (parts.length > 1) return parts[0];
  const categoryValue = Array.isArray(frontmatter?.category)
    ? frontmatter.category[0]
    : frontmatter?.category;
  return categoryValue ? slugifyTitle(categoryValue) : "artykuly";
};
const getArticleSlug = (slugPath) => {
  const parts = slugPath.split("/");
  return parts.length > 1 ? parts.slice(1).join("/") : slugPath;
};
const normalizeCategories = (category) =>
  Array.isArray(category) ? category : category ? [category] : [];

const posts = Object.entries(entries)
  .map(([file, entry]) => {
    const slugPath = getSlugPathFromFile(file);
    const categorySlug = getCategorySlug(entry.frontmatter ?? {}, slugPath);
    const slug = getArticleSlug(slugPath);
    const date = entry.frontmatter?.date ? new Date(entry.frontmatter.date) : null;
    return {
      slug,
      categorySlug,
      ...entry.frontmatter,
      date,
    };
  })
  .filter((post) =>
    normalizeCategories(post.category).some(
      (category) => slugifyTitle(category) === "sen-i-regeneracja"
    )
  )
  .sort((a, b) => {
    const aTime = a.date ? a.date.getTime() : 0;
    const bTime = b.date ? b.date.getTime() : 0;
    return bTime - aTime;
  })
  .slice(0, 8);

const formatDate = (value) =>
  value
    ? value.toLocaleDateString("pl-PL", { day: "2-digit", month: "long", year: "numeric" })
    : null;
const getPostUrl = (post) => `/artykuly/${post.categorySlug}/${post.slug}/`;
---

<div class="max-w-7xl pb-20 pt-18 bg-white">
  <div class="flex justify-between items-center mb-8 border-b border-gray-400 pb-4">
    <h2 class="text-2xl font-bold text-gray-900 uppercase tracking-tight">Sen i regeneracja</h2>
    <div class="flex gap-2">
      <button class="p-2 border rounded-full hover:bg-gray-50 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
      </button>
      <button class="p-2 border rounded-full hover:bg-gray-50 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
    {posts.map((post) => {
      const image = resolveArticleImage(post.tileImage ?? post.thumbnail);
      const dateLabel = post.date ? formatDate(post.date) : null;
      return (
        <a class="group cursor-pointer" href={getPostUrl(post)}>
          <div class="relative overflow-hidden rounded-sm mb-4 aspect-[4/3]">
            {image ? (
              <Image
                src={image}
                alt={post.title ?? post.slug}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                widths={[320, 480]}
                sizes="(max-width: 1024px) 50vw, 25vw"
                loading="lazy"
              />
            ) : (
              <div class="w-full h-full bg-neutral-200"></div>
            )}
          </div>

          <div class="flex flex-col gap-2">
            <h3 class="text-lg font-bold text-gray-900 leading-tight group-hover:text-sky-500 transition-colors line-clamp-2">
              {post.title ?? post.slug}
            </h3>
            {post.description ? (
              <p class="text-sm text-gray-500 leading-relaxed line-clamp-3">
                {post.description}
              </p>
            ) : null}

            <div class="flex justify-between items-center mt-2 text-[11px] text-gray-400 font-medium">
              {dateLabel ? (
                <span class="flex items-center gap-1.5 uppercase tracking-wide">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  {dateLabel}
                </span>
              ) : (
                <span></span>
              )}
              <span class="text-xs font-semibold uppercase text-sky-600">Czytaj</span>
            </div>
          </div>
        </a>
      );
    })}
  </div>
</div>