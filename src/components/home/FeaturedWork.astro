---
import { Image } from "astro:assets";

const imageEntries = import.meta.glob("/src/content/realizacje/img/**/*", { eager: true });
const resolveContentImage = (path) => {
  if (!path) return null;
  const normalized = path.startsWith("/src/") ? path : `/src${path}`;
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const entries = import.meta.glob("../../content/realizacje/*.md", { eager: true });
const works = Object.entries(entries)
  .map(([file, entry]) => {
    const slug = file.split("/").pop().replace(".md", "");
    const data = entry.frontmatter ?? {};
    return {
      slug,
      title: data.title ?? slug,
      tag: Array.isArray(data.category) ? data.category[0] : data.category,
      date: data.date ? new Date(data.date) : null,
      order: data.order,
      image: data.tileImage ?? data.thumbnail ?? data.imageMain,
    };
  })
  .filter((item) => item.title && item.image)
  .sort((a, b) => {
    const orderA = typeof a.order === "number" ? a.order : Number.MAX_SAFE_INTEGER;
    const orderB = typeof b.order === "number" ? b.order : Number.MAX_SAFE_INTEGER;
    if (orderA !== orderB) return orderA - orderB;
    const timeA = a.date instanceof Date && !Number.isNaN(a.date.getTime()) ? a.date.getTime() : 0;
    const timeB = b.date instanceof Date && !Number.isNaN(b.date.getTime()) ? b.date.getTime() : 0;
    return timeB - timeA;
  })
  .slice(0, 3);
---

<section class="relative mt-24 overflow-hidden sm:overflow-visible">
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-28 left-[-6%] h-[24rem] w-[24rem] rounded-full bg-[radial-gradient(circle,rgba(255,91,73,0.35),transparent_70%)] blur-3xl sm:-top-40 sm:left-[-15%] sm:h-[36rem] sm:w-[36rem]"></div>
    <div class="absolute -bottom-32 right-[-6%] h-[26rem] w-[26rem] rounded-full bg-[radial-gradient(circle,rgba(255,91,73,0.25),transparent_70%)] blur-3xl sm:-bottom-44 sm:right-[-12%] sm:h-[40rem] sm:w-[40rem]"></div>
  </div>
  <div class="flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between">
    <div class="space-y-3">
      <p class="text-base/7 font-semibold text-[var(--accent)]">Sprawdz</p>
      <h2 class="text-4xl font-semibold tracking-tight text-[var(--text)]">Wybrane projekty</h2>
      <p class="max-w-2xl text-base text-[var(--muted)]">
        Kilka ostatnich wdrożeń, ktore łączą estetykę z celami biznesowymi.
      </p>
    </div>
    <a class="inline-flex w-fit rounded-full bg-[var(--accent)] px-6 py-3 text-base font-semibold text-white transition hover:brightness-95 sm:inline-flex" href="/realizacje/">
      Wszystkie realizacje
    </a>
  </div>
  <div class="mt-8 grid gap-6 lg:grid-cols-3">
    {works.map((work) => {
      const image = resolveContentImage(work.image);
      const year = work.date ? work.date.getFullYear() : null;
      return (
        <a
          class="flex flex-col gap-6 rounded-3xl border border-[var(--border)] bg-[var(--surface)] p-6 text-[var(--text)] no-underline shadow-[0_24px_60px_-40px_rgba(0,0,0,0.7)] transition hover:-translate-y-1"
          href={`/realizacje/${work.slug}/`}
        >
          {image ? (
            <Image
              class="aspect-[4/4] w-full rounded-2xl border border-[var(--border)] object-cover"
              src={image}
              alt={work.title}
              widths={[320, 480, 768, 960]}
              sizes="(max-width: 768px) 100vw, 440px"
              loading="lazy"
              placeholder="blur"
            />
          ) : (
            <div class="grid aspect-[4/3] place-items-center rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)] text-xs uppercase tracking-widest text-[var(--muted)]">Brak zdjecia</div>
          )}
          <div class="space-y-2">
            {work.tag ? <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[var(--muted)]">{work.tag}</p> : null}
            <h3 class="text-xl font-semibold text-[var(--text)]">{work.title}</h3>
            {year ? <p class="text-sm text-[var(--muted)]">{year}</p> : null}
          </div>
        </a>
      );
    })}
  </div>
</section>
