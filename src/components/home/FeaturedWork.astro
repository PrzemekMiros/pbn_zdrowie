---
import { Image } from "astro:assets";
import { resolveContentImage } from '../../utils/resolveContentImage';

const entries = import.meta.glob("../../content/realizacje/*.md", { eager: true });
const works = Object.entries(entries)
  .map(([file, entry]) => {
    const slug = file.split("/").pop().replace(".md", "");
    const data = entry.frontmatter ?? {};
    return {
      slug,
      title: data.title ?? slug,
      tag: Array.isArray(data.category) ? data.category[0] : data.category,
      date: data.date ? new Date(data.date) : null,
      order: data.order,
      image: data.tileImage ?? data.thumbnail ?? data.imageMain,
      background: data.background ?? data.tileBg,
    };
  })
  .filter((item) => item.title && item.image)
  .sort((a, b) => {
    const orderA = typeof a.order === "number" ? a.order : Number.MAX_SAFE_INTEGER;
    const orderB = typeof b.order === "number" ? b.order : Number.MAX_SAFE_INTEGER;
    if (orderA !== orderB) return orderB - orderA;
    const timeA = a.date instanceof Date && !Number.isNaN(a.date.getTime()) ? a.date.getTime() : 0;
    const timeB = b.date instanceof Date && !Number.isNaN(b.date.getTime()) ? b.date.getTime() : 0;
    return timeB - timeA;
  })
  .slice(0, 3);
---

<section class="relative bg-white pt-20 pb-20 md:pb-24">
  <div class="absolute inset-y-0 left-1/2 w-screen -translate-x-1/2 bg-white"></div>
  <div class="relative flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
    <div class="space-y-3 max-w-3xl">
      <p class="text-[12px] font-semibold uppercase tracking-[0.1em] text-[var(--accent)]">Wybrane realizacje</p>
      <h2 class="text-2xl sm:text-3xl md:text-4xl font-semibold tracking-tight text-black">Od stron wizytówek po zaawansowane portale i systemy ecommerce <span class="text-black/50">łączące estetykę z funkcjonalnością</span></h2>
    </div>
    <a class="hidden xl:inline-flex w-fit rounded-full bg-[var(--accent)] px-6 py-3 text-base font-semibold text-white transition hover:brightness-95" href="/realizacje/" title="Wszystkie realizacje">
      Wszystkie realizacje
    </a>
  </div>
  <div class="relative mt-8 grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {works.map((work) => {
      const image = resolveContentImage(work.image);
      const year = work.date ? work.date.getFullYear() : null;
      return (
        <article
          class="group relative overflow-hidden rounded-[16px] border border-black/5 bg-[#f5f5f7] transition"
          style={work.background ? `background-color: ${work.background};` : undefined}
        >
          <div class="relative aspect-[4/4] overflow-hidden rounded-[16px] bg-white border border-black/5">
            {image ? (
              <Image
                class="h-full w-full object-cover transition-transform duration-700 ease-in-out group-hover:scale-110"
                src={image}
                alt={work.title}
                widths={[320, 480, 768, 960]}
                sizes="(max-width: 768px) 100vw, 440px"
                loading="lazy"
                placeholder="blur"
              />
            ) : (
              <div class="flex h-full items-center justify-center bg-gray-200 text-xs uppercase tracking-[0.3em] text-gray-400">
                Brak zdjęcia
              </div>
            )}
          </div>

          <div class="relative z-10 mt-6 px-4 pb-6">
            <div class="flex items-center justify-between">
              <div class="pr-4 space-y-2">
                {year ? <span class="block text-gray-500 text-xs font-medium lowercase">{year}</span> : null}
                <h3 class="text-xl font-semibold leading-tight tracking-tight text-gray-900">
                  {work.title}
                </h3>
              </div>
              <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-white text-gray-900 shadow-sm transition-colors duration-300 group-hover:bg-[var(--accent)] group-hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </div>
            </div>
          </div>
          <a
            class="absolute inset-0 z-20"
            href={`/realizacje/${work.slug}/`}
            aria-label={`Zobacz realizacje: ${work.title}`}
          ></a>
        </article>
      );
    })}
  </div>
</section>
