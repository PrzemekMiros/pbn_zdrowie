---
import { Image } from "astro:assets";
import { slugifyTitle } from "../../lib/slugifyTitle";

const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });
const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const relativePath = normalized.slice("/content/posts/img/".length);
    normalized = `/src/content/artykuly/img/${relativePath}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const entries = import.meta.glob("../../content/artykuly/**/*.md", { eager: true });
const getSlugPathFromFile = (file) =>
  file.replace(/^.*content\/artykuly\//, "").replace(/\.md$/, "");
const getCategorySlug = (frontmatter, slugPath) => {
  const parts = slugPath.split("/");
  if (parts.length > 1) return parts[0];
  const categoryValue = Array.isArray(frontmatter?.category)
    ? frontmatter.category[0]
    : frontmatter?.category;
  return categoryValue ? slugifyTitle(categoryValue) : "artykuly";
};
const getArticleSlug = (slugPath) => {
  const parts = slugPath.split("/");
  return parts.length > 1 ? parts.slice(1).join("/") : slugPath;
};

const posts = Object.entries(entries)
  .map(([file, entry]) => {
    const slugPath = getSlugPathFromFile(file);
    const categorySlug = getCategorySlug(entry.frontmatter ?? {}, slugPath);
    const slug = getArticleSlug(slugPath);
    const date = entry.frontmatter?.date ? new Date(entry.frontmatter.date) : null;
    return {
      slug,
      categorySlug,
      ...entry.frontmatter,
      date,
    };
  })
  .sort((a, b) => {
    const aTime = a.date ? a.date.getTime() : 0;
    const bTime = b.date ? b.date.getTime() : 0;
    return bTime - aTime;
  })
  .slice(0, 5);

const [mainPost, ...sidePosts] = posts;
const formatDate = (value) =>
  value
    ? value.toLocaleDateString("pl-PL", { day: "2-digit", month: "long", year: "numeric" })
    : null;
const getCategoryLabel = (post) => {
  const category = Array.isArray(post?.category) ? post.category[0] : post?.category;
  return category ?? "Artykul";
};
const getAuthor = (post) => post?.author ?? "Redakcja";
const getPostUrl = (post) => `/artykuly/${post.categorySlug}/${post.slug}/`;
---

<div class="max-w-7xl mx-auto pb-20 pt-8 font-sans">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {mainPost ? (
      <a class="lg:col-span-2 relative group overflow-hidden rounded-sm cursor-pointer" href={getPostUrl(mainPost)}>
        <div class="aspect-video lg:aspect-auto lg:h-full relative">
          {resolveArticleImage(mainPost.tileImage ?? mainPost.thumbnail) ? (
            <Image
              src={resolveArticleImage(mainPost.tileImage ?? mainPost.thumbnail)}
              alt={mainPost.title ?? mainPost.slug}
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
              widths={[480, 960, 1200, 1600]}
              sizes="(max-width: 1024px) 100vw, 66vw"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full bg-neutral-200"></div>
          )}

          <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>

          <div class="absolute bottom-0 left-0 p-6 lg:p-10 w-full text-white">
            <span class="bg-sky-500 text-white text-[10px] font-bold px-3 py-1 uppercase tracking-wider mb-4 inline-block">
              {getCategoryLabel(mainPost)}
            </span>
            <h2 class="text-2xl lg:text-4xl font-bold leading-tight mb-4">
              {mainPost.title ?? mainPost.slug}
            </h2>

            <div class="flex items-center gap-4 text-xs text-gray-300">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full border border-gray-500 bg-black/40"></div>
                <span class="font-semibold text-white">{getAuthor(mainPost)}</span>
              </div>
              {mainPost.date ? (
                <div class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>{formatDate(mainPost.date)}</span>
                </div>
              ) : null}
            </div>
          </div>

          <div class="absolute bottom-6 right-6">
            <div class="bg-black/40 p-2 rounded hover:bg-black/60 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
              </svg>
            </div>
          </div>
        </div>
      </a>
    ) : null}

    <div class="flex flex-col gap-6">
      {sidePosts.map((post, index) => {
        const image = resolveArticleImage(post.tileImage ?? post.thumbnail);
        const dateLabel = post.date ? formatDate(post.date) : null;
        const dividerClass = index === 0 ? "" : "border-t pt-6 lg:border-t-0 lg:pt-0";
        return (
          <a class={`flex gap-4 group cursor-pointer border-b border-black/20 pb-6 ${dividerClass}`} href={getPostUrl(post)}>
            <div class="w-1/3 shrink-0 overflow-hidden rounded-sm">
              {image ? (
                <Image
                  src={image}
                  alt={post.title ?? post.slug}
                  class="w-full h-24 object-cover transition-transform duration-500 group-hover:scale-110"
                  widths={[240, 360]}
                  sizes="120px"
                  loading="lazy"
                />
              ) : (
                <div class="w-full h-24 bg-neutral-200"></div>
              )}
            </div>
            <div class="w-2/3 flex flex-col justify-between">
              <div>
                <span class="text-sky-500 text-[10px] font-bold uppercase tracking-widest">
                  {getCategoryLabel(post)}
                </span>
                <h3 class="font-semibold text-gray-900 line-clamp-2 group-hover:text-sky-500 transition-colors">
                  {post.title ?? post.slug}
                </h3>
              </div>
              <div class="flex justify-between items-center text-[10px] text-gray-500 font-medium">
                {dateLabel ? (
                  <span class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {dateLabel}
                  </span>
                ) : (
                  <span></span>
                )}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
              </div>
            </div>
          </a>
        );
      })}
    </div>
  </div>
</div>
