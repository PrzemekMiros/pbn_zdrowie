---
import { Image } from "astro:assets";
import { slugifyTitle } from "../../lib/slugifyTitle";

const TARGET_CATEGORY = "Układ nerwowy";
const TARGET_CATEGORY_SLUG = slugifyTitle(TARGET_CATEGORY);
const imageEntries = import.meta.glob("/src/content/artykuly/img/**/*", { eager: true });

const resolveArticleImage = (path) => {
  if (!path) return null;
  let normalized = path;
  if (normalized.startsWith("/content/posts/img/")) {
    const relativePath = normalized.slice("/content/posts/img/".length);
    normalized = `/src/content/artykuly/img/${relativePath}`;
  } else if (normalized.startsWith("/content/")) {
    normalized = `/src${normalized}`;
  }
  const entry = imageEntries[normalized];
  return entry?.default ?? null;
};

const entries = import.meta.glob("../../content/artykuly/**/*.md", { eager: true });
const normalizeCategories = (category) =>
  Array.isArray(category) ? category : category ? [category] : [];
const getSlugPathFromFile = (file) =>
  file.replace(/^.*content\/artykuly\//, "").replace(/\.md$/, "");
const getCategorySlug = (frontmatter, slugPath) => {
  const parts = slugPath.split("/");
  if (parts.length > 1) return parts[0];
  const categoryValue = Array.isArray(frontmatter?.category)
    ? frontmatter.category[0]
    : frontmatter?.category;
  return categoryValue ? slugifyTitle(categoryValue) : "artykuly";
};
const getArticleSlug = (slugPath) => {
  const parts = slugPath.split("/");
  return parts.length > 1 ? parts.slice(1).join("/") : slugPath;
};

const posts = Object.entries(entries)
  .map(([file, entry]) => {
    const slugPath = getSlugPathFromFile(file);
    const categorySlug = getCategorySlug(entry.frontmatter ?? {}, slugPath);
    const slug = getArticleSlug(slugPath);
    const date = entry.frontmatter?.date ? new Date(entry.frontmatter.date) : null;
    return {
      slug,
      categorySlug,
      ...entry.frontmatter,
      date,
    };
  })
  .filter((post) =>
    normalizeCategories(post.category).some(
      (category) => slugifyTitle(category) === TARGET_CATEGORY_SLUG
    )
  )
  .sort((a, b) => {
    const aTime = a.date ? a.date.getTime() : 0;
    const bTime = b.date ? b.date.getTime() : 0;
    return bTime - aTime;
  })
  .slice(0, 4);

const [featured, wide, smallOne, smallTwo] = posts;
const getPostUrl = (post) => `/artykuly/${post.categorySlug}/${post.slug}/`;
---

<div class="relative max-w-7xl pb-20 pt-18">
  <div class="absolute inset-y-0 left-1/2 w-screen -translate-x-1/2 bg-gray-100 overflow-hidden -z-1" style="perspective: 1000px;"></div>
  <div class="mb-8 border-b pb-4">
    <h2 class="text-2xl font-bold text-gray-900 uppercase tracking-tight">{TARGET_CATEGORY}</h2>
  </div>

  {posts.length ? (
    <div class="grid grid-cols-1 md:grid-cols-4 grid-rows-none md:grid-rows-2 gap-4 h-auto md:h-[500px]">
      {featured ? (
        <a class="md:col-span-2 md:row-span-2 relative group overflow-hidden rounded-md cursor-pointer" href={getPostUrl(featured)}>
          {resolveArticleImage(featured.tileImage ?? featured.thumbnail) ? (
            <Image
              src={resolveArticleImage(featured.tileImage ?? featured.thumbnail)}
              alt={featured.title ?? featured.slug}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              widths={[480, 768, 960, 1280]}
              sizes="(max-width: 768px) 100vw, 50vw"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full bg-neutral-300"></div>
          )}
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-8 text-white">
            <span class="bg-sky-500 text-[10px] font-bold px-2 py-1 uppercase mb-3 inline-block">Najnowszy</span>
            <h3 class="text-3xl font-bold leading-tight mb-2 line-clamp-3">{featured.title ?? featured.slug}</h3>
            {featured.description ? (
              <p class="text-sm text-gray-300 opacity-80 group-hover:opacity-100 transition-opacity duration-300 line-clamp-2">
                {featured.description}
              </p>
            ) : null}
          </div>
        </a>
      ) : null}

      {wide ? (
        <a class="md:col-span-2 relative group overflow-hidden rounded-md cursor-pointer h-[250px] md:h-auto" href={getPostUrl(wide)}>
          {resolveArticleImage(wide.tileImage ?? wide.thumbnail) ? (
            <Image
              src={resolveArticleImage(wide.tileImage ?? wide.thumbnail)}
              alt={wide.title ?? wide.slug}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              widths={[480, 768, 960]}
              sizes="(max-width: 768px) 100vw, 50vw"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full bg-neutral-300"></div>
          )}
          <div class="absolute inset-0 bg-black/30 group-hover:bg-black/50 transition-colors"></div>
          <div class="absolute inset-0 flex flex-col justify-center items-center text-white p-4 text-center">
            <h3 class="text-xl font-bold uppercase tracking-widest line-clamp-3">{wide.title ?? wide.slug}</h3>
            <div class="w-10 h-1 bg-sky-500 mt-2 transition-all group-hover:w-24"></div>
          </div>
        </a>
      ) : null}

      {smallOne ? (
        <a class="md:col-span-1 relative group overflow-hidden rounded-md cursor-pointer h-[250px] md:h-auto" href={getPostUrl(smallOne)}>
          {resolveArticleImage(smallOne.tileImage ?? smallOne.thumbnail) ? (
            <Image
              src={resolveArticleImage(smallOne.tileImage ?? smallOne.thumbnail)}
              alt={smallOne.title ?? smallOne.slug}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              widths={[320, 480]}
              sizes="(max-width: 768px) 100vw, 25vw"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full bg-neutral-300"></div>
          )}
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-4 text-white">
            <h3 class="font-bold text-sm line-clamp-3">{smallOne.title ?? smallOne.slug}</h3>
          </div>
        </a>
      ) : null}

      {smallTwo ? (
        <a class="md:col-span-1 relative group overflow-hidden rounded-md cursor-pointer h-[250px] md:h-auto" href={getPostUrl(smallTwo)}>
          {resolveArticleImage(smallTwo.tileImage ?? smallTwo.thumbnail) ? (
            <Image
              src={resolveArticleImage(smallTwo.tileImage ?? smallTwo.thumbnail)}
              alt={smallTwo.title ?? smallTwo.slug}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              widths={[320, 480]}
              sizes="(max-width: 768px) 100vw, 25vw"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full bg-neutral-300"></div>
          )}
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-4 text-white">
            <h3 class="font-bold text-sm line-clamp-3">{smallTwo.title ?? smallTwo.slug}</h3>
          </div>
        </a>
      ) : null}
    </div>
  ) : (
    <p class="rounded-md border border-dashed border-gray-300 bg-white/70 p-6 text-sm text-gray-500">
      Brak wpisow w kategorii „{TARGET_CATEGORY}”.
    </p>
  )}
</div>
